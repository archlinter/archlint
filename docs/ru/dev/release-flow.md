# Процесс релиза

Этот документ описывает процесс релиза для archlint.

## Обзор

archlint использует **semantic-release** для автоматизации всего процесса релиза. Номера версий рассчитываются на основе сообщений коммитов, следующих формату Conventional Commits.

## Формат сообщений коммитов

Все коммиты **должны** следовать формату Conventional Commits. Это проверяется с помощью commitlint в CI.

### Формат

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Типы

| Тип        | Описание                     | Повышение версии  |
| ---------- | ---------------------------- | ----------------- |
| `feat`     | Новая функциональность       | **Minor** (0.x.0) |
| `fix`      | Исправление ошибки           | **Patch** (0.0.x) |
| `perf`     | Улучшение производительности | **Patch** (0.0.x) |
| `refactor` | Рефакторинг кода             | Нет               |
| `docs`     | Документация                 | Нет               |
| `test`     | Тесты                        | Нет               |
| `chore`    | Обслуживание                 | Нет               |
| `ci`       | Изменения CI/CD              | Нет               |
| `build`    | Система сборки               | Нет               |

### Breaking Changes (Обратно несовместимые изменения)

Добавьте `!` после типа или `BREAKING CHANGE:` в футере, чтобы вызвать повышение **мажорной** версии:

```bash
# Мажорное повышение версии (1.0.0)
git commit -m "feat!: change API signature"

# Или
git commit -m "feat: new feature

BREAKING CHANGE: This changes the public API"
```

## Процесс релиза

### 1. Разработка

Разрабатывайте функции в ветках фич и объединяйте их в `main`.

### Предрелизные ветки

Файл `.releaserc.json` содержит статическую конфигурацию веток для каналов `beta` и `alpha`. Однако **предрелизные ветки настраиваются динамически в CI** во время процесса релиза. Рабочий процесс автоматически создает конфигурации веток на основе выбранного канала и текущего имени ветки, поэтому статические записи в `.releaserc.json` не используются во время реальных релизов.

### 2. Запуск релиза

Когда вы готовы к релизу, вручную запустите рабочий процесс Release:

1. Перейдите в **Actions** -> рабочий процесс **Release**.
2. Нажмите **Run workflow**.
3. (Опционально) Установите `dry_run` в `true`, чтобы увидеть, что произойдет без реальной публикации.

### 3. Автоматические шаги

Рабочий процесс выполнит:

1. **Расчет версии**: `semantic-release` анализирует коммиты с момента последнего релиза.
2. **Обновление файлов**: Автоматически обновляет `Cargo.toml`, `package.json` и `CHANGELOG.md`.
3. **Коммит и тег**: Создает новый коммит и тег Git для релиза.
4. **Запуск CI**: Пуш тега запускает рабочий процесс CI, который собирает все бинарные файлы.
5. **Публикация в npm**: CI публикует все пакеты в реестр npm (только на тегах).
6. **Прикрепление бинарных файлов**: CI загружает автономные бинарные файлы в GitHub Release.

## Номера версий

Все пакеты имеют одну и ту же версию (единая версионность):

- `@archlinter/cli@0.2.0`
- `@archlinter/cli-darwin-arm64@0.2.0`
- `@archlinter/cli-linux-x64@0.2.0`
- и т.д.

## Проверка статуса релиза

### Просмотр статуса Workflow

https://github.com/archlinter/actions

### Проверка публикации в npm

```bash
npm view @archlinter/cli
```

### Тестирование установки

```bash
npx @archlinter/cli@latest --version
```

## Устранение неполадок

### Коммит отклонен commitlint

**Исправление**: Следуйте формату conventional commits:

```bash
git commit --amend -m "feat: correct commit message"
```

### Сбой рабочего процесса Release

Проверьте:

1. Настроен ли секрет NPM_TOKEN?
2. Настроен ли секрет GH_PAT?
3. Завершилась ли сборка CI неудачей?

## Ссылки

- [Conventional Commits](https://www.conventionalcommits.org/)
- [Semantic Versioning](https://semver.org/)
- [semantic-release](https://github.com/semantic-release/semantic-release)
