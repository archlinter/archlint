name: Release

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  update-versions:
    name: Update Versions
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in all files
        run: node scripts/sync-versions.cjs ${{ steps.version.outputs.VERSION }}

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DATE=$(date +%Y-%m-%d)
          RELEASE_BODY=$(cat <<'EOF'
          ${{ github.event.release.body }}
          EOF
          )

          # Create new changelog entry
          NEW_ENTRY="## [$VERSION] - $DATE

          $RELEASE_BODY
          "

          # Insert after the header
          if [ -f CHANGELOG.md ]; then
            # Find the first ## and insert before it
            if grep -q "^## \[" CHANGELOG.md; then
              sed -i "0,/^## \[/s//## [$VERSION] - $DATE\n\n$RELEASE_BODY\n\n## [/" CHANGELOG.md
            else
              echo -e "# Changelog\n\n$NEW_ENTRY" > CHANGELOG.md
            fi
          else
            echo -e "# Changelog\n\n$NEW_ENTRY" > CHANGELOG.md
          fi

      - name: Commit version updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore(release): ${{ steps.version.outputs.VERSION }} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:main

  get-ci-run:
    name: Get CI Workflow Run
    runs-on: ubuntu-latest
    needs: [update-versions]
    outputs:
      run_id: ${{ steps.get-run.outputs.run_id }}
    steps:
      - name: Get latest successful CI run
        id: get-run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/ci.yml/runs?branch=main&status=success&per_page=1" \
            --jq '.workflow_runs[0].id')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Using CI workflow run: $RUN_ID"

  verify:
    name: Verify
    runs-on: ubuntu-latest
    needs: [update-versions]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --workspace --all-features

  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [update-versions, verify, get-ci-run]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install

      - name: Download artifacts from CI
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          run_id: ${{ needs.get-ci-run.outputs.run_id }}
          path: artifacts

      - name: Replace workspace protocol with versions
        run: node scripts/sync-versions.cjs ${{ needs.update-versions.outputs.version }} --publish

      - name: Prepare core packages
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-x64-gnu linux-x64-musl linux-arm64-gnu win32-x64; do
            mkdir -p packages/core-${pkg}
            cp artifacts/core-${pkg}/*.node packages/core-${pkg}/
          done

      - name: Publish platform core packages
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-x64-gnu linux-x64-musl linux-arm64-gnu win32-x64; do
            cd packages/core-${pkg}
            npm publish --access public --provenance
            cd ../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @archlinter/core
        run: |
          cd packages/core
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Prepare CLI packages
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-x64 linux-x64-musl linux-arm64 win32-x64; do
            mkdir -p packages/cli-${pkg}/bin
            if [ -f "artifacts/cli-${pkg}/archlint" ]; then
              cp artifacts/cli-${pkg}/archlint packages/cli-${pkg}/bin/
              chmod +x packages/cli-${pkg}/bin/archlint
            elif [ -f "artifacts/cli-${pkg}/archlint.exe" ]; then
              cp artifacts/cli-${pkg}/archlint.exe packages/cli-${pkg}/bin/
            fi
          done

      - name: Publish platform CLI packages
        run: |
          for pkg in darwin-arm64 darwin-x64 linux-x64 linux-x64-musl linux-arm64 win32-x64; do
            cd packages/cli-${pkg}
            npm publish --access public --provenance
            cd ../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @archlinter/cli
        run: |
          cd packages/cli
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  attach-binaries:
    name: Attach Binary Assets to Release
    runs-on: ubuntu-latest
    needs: [publish, get-ci-run]
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts from CI
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          run_id: ${{ needs.get-ci-run.outputs.run_id }}
          path: artifacts
          name: cli-.*
          name_is_regexp: true

      - name: Prepare release assets
        run: |
          mkdir -p release
          for pkg in darwin-arm64 darwin-x64 linux-x64 linux-x64-musl linux-arm64; do
            if [ -f "artifacts/cli-${pkg}/archlint" ]; then
              tar -czvf "release/archlint-${pkg}.tar.gz" -C "artifacts/cli-${pkg}" archlint
            fi
          done
          if [ -f "artifacts/cli-win32-x64/archlint.exe" ]; then
            cd artifacts/cli-win32-x64
            zip ../../release/archlint-win32-x64.zip archlint.exe
            cd ../..
          fi

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: release/*
